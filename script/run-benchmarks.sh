#!/usr/bin/env bash
#
# run-benchmarks.sh - Run PARSEC, SPLASH-4, and Phoenix experiments
#
# This script runs experiments for Figures 11, 12, 16, and 17.
# Uses the configuration file generated by create-conf.sh
#
# Usage:
#   ./script/run-benchmarks.sh                    # Run all benchmark suites
#   ./script/run-benchmarks.sh parsec             # Run only PARSEC
#   ./script/run-benchmarks.sh splash             # Run only SPLASH-4
#   ./script/run-benchmarks.sh phoenix            # Run only Phoenix
#   ./script/run-benchmarks.sh parsec blackscholes    # Run specific app
#
# Required for: Figure 11, 12, 16, 17
#
set -eo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
CONFIG_FILE="${REPO_ROOT}/benchmarks/configuration/commands.conf"
DATA_DIR="${REPO_ROOT}/data"
LOG_DIR="${DATA_DIR}/logs"

# Valid suites for this script
VALID_SUITES=("parsec" "splash" "phoenix")

# Filters (optional)
FILTER_SUITE="${1:-}"
FILTER_APP="${2:-}"
FILTER_PROTOCOL="${3:-}"

# Validate suite filter
if [[ -n "${FILTER_SUITE}" ]]; then
    valid=false
    for s in "${VALID_SUITES[@]}"; do
        [[ "${FILTER_SUITE}" == "$s" ]] && valid=true && break
    done
    if [[ "${valid}" == "false" ]]; then
        echo "ERROR: Invalid suite '${FILTER_SUITE}'"
        echo "Valid suites for this script: ${VALID_SUITES[*]}"
        echo ""
        echo "For YCSB experiments, use: ./script/run-ycsb.sh"
        exit 1
    fi
fi

# Check if config file exists
if [[ ! -f "${CONFIG_FILE}" ]]; then
    echo "ERROR: Configuration file not found: ${CONFIG_FILE}"
    echo "Run './script/create-conf.sh' first to generate it."
    exit 1
fi

# Check if required gem5 builds exist
REQUIRED_BUILDS=("MOESI_CMP_directory" "MESI_unord" "MESI_unord_CXL")
MISSING_BUILDS=()
for protocol in "${REQUIRED_BUILDS[@]}"; do
    if [[ ! -f "${REPO_ROOT}/gem5/build/X86_${protocol}/gem5.opt" ]]; then
        MISSING_BUILDS+=("X86_${protocol}")
    fi
done

if [[ ${#MISSING_BUILDS[@]} -gt 0 ]]; then
    echo "ERROR: Missing gem5 builds: ${MISSING_BUILDS[*]}"
    echo "Run './script/build-gem5.sh' first to build gem5."
    exit 1
fi

# Create directories
mkdir -p "${LOG_DIR}"
mkdir -p "${LOG_DIR}/backup"

# PID file for tracking running processes
PID_FILE="${DATA_DIR}/running_pids_benchmarks.txt"
> "${PID_FILE}"

cd "${REPO_ROOT}"

echo "=============================================="
echo "Running Benchmark Experiments"
echo "(PARSEC, SPLASH-4, Phoenix)"
echo "=============================================="
echo "Config file: ${CONFIG_FILE}"
echo "Required for: Figures 11, 12, 16, 17"
echo ""
echo "Data directory: ${DATA_DIR}"
echo "Log directory: ${LOG_DIR}"
[[ -n "${FILTER_SUITE}" ]] && echo "Filter suite: ${FILTER_SUITE}"
[[ -n "${FILTER_APP}" ]] && echo "Filter app: ${FILTER_APP}"
[[ -n "${FILTER_PROTOCOL}" ]] && echo "Filter protocol: ${FILTER_PROTOCOL}"
echo "=============================================="
echo ""

#------------------------------------------------------------------------------
# Run a single experiment in background
#------------------------------------------------------------------------------
run_experiment() {
    local suite="$1"
    local csv_protocol="$2"
    local name="$3"
    local cmd_line="$4"
    local log_file="${LOG_DIR}/${suite}_${name}_${csv_protocol}.log"
    
    if [[ -f "$log_file" ]]; then
        local timestamp=$(date +"%Y%m%d_%H%M%S")
        cp "$log_file" "${LOG_DIR}/backup/${suite}_${name}_${csv_protocol}_${timestamp}.log"
    fi
    
    {
        echo "[$(date)] STARTING: ${suite}/${name}/${csv_protocol}"
        local start_time=$(date +%s)
        
        cd "${REPO_ROOT}"
        if eval "${cmd_line}"; then
            local end_time=$(date +%s)
            local duration=$((end_time - start_time))
            echo "[$(date)] COMPLETED: ${suite}/${name}/${csv_protocol} in ${duration}s"
        else
            local exit_code=$?
            local end_time=$(date +%s)
            local duration=$((end_time - start_time))
            echo "[$(date)] FAILED: ${suite}/${name}/${csv_protocol} after ${duration}s (exit code: ${exit_code})"
        fi
    } > "${log_file}" 2>&1 &
    
    LAST_PID=$!
}

#------------------------------------------------------------------------------
# Main execution
#------------------------------------------------------------------------------
declare -a running_pids=()
declare -A pid_info=()

experiments_started=0

while IFS= read -r line || [[ -n "$line" ]]; do
    [[ -z "$line" || "$line" =~ ^# ]] && continue
    [[ "$line" =~ ^\[([a-z]+)\] ]] && continue
    
    IFS='|' read -r suite csv_protocol name cmd_line <<< "$line"
    
    suite=$(echo "$suite" | xargs)
    csv_protocol=$(echo "$csv_protocol" | xargs)
    name=$(echo "$name" | xargs)
    cmd_line=$(echo "$cmd_line" | xargs)
    
    # Skip YCSB - this script is only for parsec/splash/phoenix
    [[ "$suite" == "ycsb" ]] && continue
    
    # Apply filters
    [[ -n "${FILTER_SUITE}" && "$suite" != "${FILTER_SUITE}" ]] && continue
    [[ -n "${FILTER_APP}" && "$name" != "${FILTER_APP}" && ! "$name" =~ ${FILTER_APP} ]] && continue
    [[ -n "${FILTER_PROTOCOL}" && "$csv_protocol" != "${FILTER_PROTOCOL}" ]] && continue
    
    # Check if output already exists
    out_dir=$(echo "$cmd_line" | grep -oP '(?<=--outdir=)[^ ]+')
    if [[ -f "${REPO_ROOT}/${out_dir}/stats.txt" ]]; then
        echo "SKIP: ${suite}/${name}/${csv_protocol} (stats.txt exists)"
        continue
    fi
    
    echo "QUEUE: ${suite}/${name}/${csv_protocol}"
    
    run_experiment "$suite" "$csv_protocol" "$name" "$cmd_line"
    running_pids+=("$LAST_PID")
    pid_info["$LAST_PID"]="${suite}/${name}/${csv_protocol}"
    echo "$LAST_PID ${suite}/${name}/${csv_protocol}" >> "${PID_FILE}"
    
    experiments_started=$((experiments_started + 1))
    
done < "${CONFIG_FILE}"

echo ""
echo "=============================================="
echo "Started ${experiments_started} benchmark experiments"
echo "=============================================="
echo ""

if [[ ${#running_pids[@]} -gt 0 ]]; then
    echo "Waiting for experiments to complete..."
    echo "Monitor progress: tail -f ${LOG_DIR}/*.log"
    echo ""
    
    for pid in "${running_pids[@]}"; do
        wait "$pid" 2>/dev/null || true
    done
    
    echo ""
    echo "=============================================="
    echo "All benchmark experiments completed!"
    echo "=============================================="
fi

echo ""
echo "Results saved in: ${DATA_DIR}/gem5.output/"
echo "Logs saved in: ${LOG_DIR}/"
echo ""
echo "These results are required for: Figures 11, 12, 16, 17"
echo ""
echo "Next step: Run './script/plot.sh' to generate figures"
